<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NEXUS Web Service</title>
  <style>
    :root { --bg:#0b1020; --card:#121a33; --line:#22305a; --text:#e8eeff; --sub:#90a4d6; }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{margin:0;background:var(--bg);color:var(--text);padding:24px}
    .wrap{max-width:1100px;margin:0 auto;display:grid;gap:16px;grid-template-columns:380px 1fr}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px}
    h1{font-size:20px;margin:0 0 10px}
    h2{font-size:14px;margin:0 0 10px;color:var(--sub);font-weight:600}
    input,button{width:100%;padding:12px;border-radius:10px;border:1px solid var(--line);background:#0e1530;color:var(--text)}
    input{margin:8px 0}
    button{cursor:pointer;margin-top:8px;background:#345bff;border-color:#345bff;font-weight:700}
    button.ghost{background:transparent;border-color:var(--line)}
    button.danger{background:#ff3b3b;border-color:#ff3b3b}
    .row{display:flex;gap:10px}
    .row > *{flex:1}
    .muted{color:var(--sub);font-size:12px;line-height:1.4}
    .pill{display:inline-block;padding:4px 8px;border:1px solid var(--line);border-radius:999px;color:var(--sub);font-size:12px}
    .jobs{display:grid;gap:10px}
    .job{border:1px solid var(--line);border-radius:12px;padding:12px;background:#0e1530}
    .jobhead{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .logs{margin-top:10px;background:#070b16;border:1px solid var(--line);border-radius:10px;padding:10px;height:120px;overflow:auto}
    .logline{font-size:12px;margin:0 0 6px;color:#dbe6ff}
    .ok{color:#68ff9b}
    .warn{color:#ffd36a}
    .err{color:#ff8a8a}
    .hide{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>NEXUS Web Service <span class="pill" id="pill">offline</span></h1>
      <p class="muted">Deploy-ready cho Render. Có login/register + dashboard job demo.</p>

      <div id="authBox">
        <h2>Đăng nhập / Đăng ký</h2>
        <input id="user" placeholder="username" />
        <input id="pass" type="password" placeholder="password" />
        <div class="row">
          <button onclick="doLogin()">Đăng nhập</button>
          <button class="ghost" onclick="doRegister()">Đăng ký</button>
        </div>
        <p class="muted" id="authMsg"></p>
      </div>

      <div id="appBox" class="hide">
        <h2>Điều khiển</h2>
        <p class="muted">User: <b id="who"></b></p>

        <input id="jobName" placeholder="Tên job (tuỳ chọn)" />
        <button onclick="startJob()">Start job demo</button>

        <div class="row">
          <button class="ghost" onclick="refresh()">Refresh</button>
          <button class="danger" onclick="stopAll()">Stop all</button>
        </div>

        <button class="ghost" onclick="logout()">Logout</button>
        <p class="muted" id="appMsg"></p>
      </div>
    </div>

    <div class="card">
      <h2>Jobs</h2>
      <div class="jobs" id="jobs"></div>
    </div>
  </div>

<script>
  let token = localStorage.getItem("token") || "";
  let username = localStorage.getItem("username") || "";

  const pill = document.getElementById("pill");
  const authBox = document.getElementById("authBox");
  const appBox = document.getElementById("appBox");
  const who = document.getElementById("who");
  const authMsg = document.getElementById("authMsg");
  const appMsg = document.getElementById("appMsg");
  const jobsEl = document.getElementById("jobs");

  function setOnline(ok){
    pill.textContent = ok ? "online" : "offline";
    pill.style.opacity = ok ? 1 : 0.6;
  }

  async function health(){
    try{
      const r = await fetch("/health");
      setOnline(r.ok);
    }catch(e){
      setOnline(false);
    }
  }

  function setAuthed(isAuthed){
    authBox.classList.toggle("hide", isAuthed);
    appBox.classList.toggle("hide", !isAuthed);
    if(isAuthed){
      who.textContent = username || "...";
    }
  }

  async function api(path, opts={}){
    const headers = opts.headers || {};
    if(token) headers["Authorization"] = "Bearer " + token;
    headers["Content-Type"] = "application/json";
    const r = await fetch(path, { ...opts, headers });
    return r.json();
  }

  async function doRegister(){
    authMsg.textContent = "";
    const u = document.getElementById("user").value.trim();
    const p = document.getElementById("pass").value.trim();
    const res = await api("/api/register", { method:"POST", body: JSON.stringify({username:u,password:p}) });
    authMsg.textContent = res.msg || (res.success ? "OK" : "Fail");
  }

  async function doLogin(){
    authMsg.textContent = "";
    const u = document.getElementById("user").value.trim();
    const p = document.getElementById("pass").value.trim();
    const res = await api("/api/login", { method:"POST", body: JSON.stringify({username:u,password:p}) });
    if(res.success){
      token = res.token;
      username = res.username;
      localStorage.setItem("token", token);
      localStorage.setItem("username", username);
      setAuthed(true);
      await refresh();
    }else{
      authMsg.textContent = res.msg || "Login fail";
    }
  }

  function logout(){
    token = "";
    username = "";
    localStorage.removeItem("token");
    localStorage.removeItem("username");
    setAuthed(false);
    jobsEl.innerHTML = "";
  }

  async function startJob(){
    appMsg.textContent = "";
    const name = document.getElementById("jobName").value.trim();
    const res = await api("/api/start", { method:"POST", body: JSON.stringify({ name }) });
    appMsg.textContent = res.msg || (res.success ? "Started" : "Fail");
    await refresh();
  }

  async function stopAll(){
    await api("/api/control", { method:"POST", body: JSON.stringify({ action:"stop_all" }) });
    await refresh();
  }

  async function control(id, action){
    await api("/api/control", { method:"POST", body: JSON.stringify({ id, action }) });
    await refresh();
  }

  function cls(type){
    if(type==="success") return "ok";
    if(type==="warning") return "warn";
    if(type==="error") return "err";
    return "";
  }

  async function refresh(){
    if(!token) return;
    const list = await api("/api/status", { method:"GET" });
    if(Array.isArray(list)){
      jobsEl.innerHTML = list.map(j => `
        <div class="job">
          <div class="jobhead">
            <div>
              <div class="mono">${j.id}</div>
              <div class="muted">name: <b>${j.name || "demo-job"}</b> • running: <b>${j.running}</b></div>
              <div class="muted">ok: <b>${j.stats?.ok ?? 0}</b> • fail: <b>${j.stats?.fail ?? 0}</b></div>
            </div>
            <div style="min-width:140px">
              <button class="ghost" onclick="control('${j.id}','stop')">Stop</button>
              <button class="danger" onclick="control('${j.id}','delete')">Delete</button>
            </div>
          </div>
          <div class="logs">
            ${(j.logs||[]).slice().reverse().map(x => `<div class="logline ${cls(x.type)}">[${x.time}] ${x.msg}</div>`).join("")}
          </div>
        </div>
      `).join("");
    }else{
      // token hết hạn/ lỗi auth
      appMsg.textContent = list.error || "Auth error";
      if(list.error) logout();
    }
  }

  // boot
  (async function init(){
    await health();
    if(token && username){
      setAuthed(true);
      await refresh();
    }else{
      setAuthed(false);
    }
    setInterval(health, 8000);
    setInterval(() => { if(token) refresh(); }, 2500);
  })();
</script>
</body>
</html>
